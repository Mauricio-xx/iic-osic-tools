name: Build IHP-EDA-Tools

on:
  push:
    branches: [main]
    tags: ['v*', '202*']
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all images'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY_GHCR: ghcr.io
  IMAGE_NAME: ihp-eda-tools

jobs:
  build-base:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push base images
        working-directory: _build
        run: |
          docker buildx bake --push base base-dev

  build-tools-level-1:
    needs: build-base
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        tool:
          - magic
          - openvaf
          - osic-multitool
          - xyce
          - covered
          - cvc_rv
          - digital
          - gaw3-xschem
          - ghdl
          - gtkwave
          - irsim
          - iverilog
          - klayout
          - netgen
          - ngspyce
          - nvc
          - openems
          - palace
          - surelog
          - surfer
          - qflow
          - qucs-s
          - slang
          - verilator
          - xcircuit
          - xschem
          - yosys
          - rftoolkit
          - openroad
          - openroad-librelane
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push ${{ matrix.tool }}
        working-directory: _build
        run: |
          docker buildx bake --push ${{ matrix.tool }}

  build-tools-level-2:
    needs: build-tools-level-1
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        tool:
          - open_pdks
          - vacask
          - ghdl-yosys-plugin
          - slang-yosys-plugin
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push ${{ matrix.tool }}
        working-directory: _build
        run: |
          docker buildx bake --push ${{ matrix.tool }}

  build-tools-level-3:
    needs: build-tools-level-2
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        tool:
          - gds3d
          - ngspice
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push ${{ matrix.tool }}
        working-directory: _build
        run: |
          docker buildx bake --push ${{ matrix.tool }}

  build-final:
    needs: build-tools-level-3
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set version tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=$(date +%Y.%m)" >> $GITHUB_OUTPUT
          fi

      - name: Build and push final image
        working-directory: _build
        env:
          DOCKER_PREFIXES: "ghcr.io/${{ github.repository_owner }},docker.io/${{ secrets.DOCKERHUB_USERNAME }}"
          DOCKER_IMAGE: ihp-eda-tools
          DOCKER_TAGS: "latest,${{ steps.version.outputs.tag }}"
        run: |
          ./build-images.sh
